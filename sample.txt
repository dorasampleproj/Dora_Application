import React, { useEffect, useState } from "react";
import axios from "axios";

const DeploymentFrequency = () => {
  const [frequency, setFrequency] = useState({});
  const [loading, setLoading] = useState(true);

  const GITHUB_TOKEN = "your_personal_access_token"; // Use repo/workflow scope
  const OWNER = "your-github-org-or-user";
  const REPO = "your-repo-name";

  useEffect(() => {
    const fetchWorkflowRuns = async () => {
      try {
        const response = await axios.get(
          `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs`,
          {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: "application/vnd.github.v3+json",
            },
          }
        );

        const runs = response.data.workflow_runs || [];
        const successfulRuns = runs.filter(run => run.conclusion === "success");

        // Group by date
        const counts = {};
        successfulRuns.forEach(run => {
          const date = new Date(run.created_at).toISOString().split("T")[0];
          counts[date] = (counts[date] || 0) + 1;
        });

        setFrequency(counts);
      } catch (error) {
        console.error("Error fetching workflow runs:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchWorkflowRuns();
  }, []);

  if (loading) return <p>Loading deployment frequency...</p>;

  return (
    <div>
      <h2>Deployment Frequency</h2>
      <table border="1" cellPadding="8">
        <thead>
          <tr>
            <th>Date</th>
            <th>Successful Deployments</th>
          </tr>
        </thead>
        <tbody>
          {Object.entries(frequency).map(([date, count]) => (
            <tr key={date}>
              <td>{date}</td>
              <td>{count}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

export default DeploymentFrequency;